{
    "sourceFile": "tests/response_test.go",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772220531052,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772220531052,
            "name": "Commit-0",
            "content": "package http_test\n\nimport (\n\t\"encoding/json\"\n\t\"net/http\"\n\t\"net/http/httptest\"\n\t\"testing\"\n\n\tgohttp \"github.com/km-arc/go-laravel/http\"\n\t\"github.com/km-arc/go-laravel/http/validation\"\n)\n\n// ── helpers ──────────────────────────────────────────────────────────────────\n\nfunc newResponse(t *testing.T) (*gohttp.Response, *httptest.ResponseRecorder) {\n\tt.Helper()\n\trr := httptest.NewRecorder()\n\treturn gohttp.NewResponse(rr), rr\n}\n\nfunc decodeJSON(t *testing.T, rr *httptest.ResponseRecorder) map[string]any {\n\tt.Helper()\n\tvar m map[string]any\n\tif err := json.NewDecoder(rr.Body).Decode(&m); err != nil {\n\t\tt.Fatalf(\"decodeJSON: %v\", err)\n\t}\n\treturn m\n}\n\n// ── JSON ──────────────────────────────────────────────────────────────────────\n\nfunc TestResponse_JSON(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.JSON(http.StatusOK, map[string]any{\"key\": \"val\"})\n\n\tif rr.Code != http.StatusOK {\n\t\tt.Errorf(\"status: got %d want 200\", rr.Code)\n\t}\n\tif ct := rr.Header().Get(\"Content-Type\"); ct != \"application/json\" {\n\t\tt.Errorf(\"Content-Type: got %q want application/json\", ct)\n\t}\n\tm := decodeJSON(t, rr)\n\tif m[\"key\"] != \"val\" {\n\t\tt.Errorf(\"body key: got %v want val\", m[\"key\"])\n\t}\n}\n\nfunc TestResponse_Success(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.Success(map[string]any{\"id\": float64(1)})\n\n\tif rr.Code != http.StatusOK {\n\t\tt.Errorf(\"status: got %d want 200\", rr.Code)\n\t}\n\tm := decodeJSON(t, rr)\n\tdata, ok := m[\"data\"].(map[string]any)\n\tif !ok {\n\t\tt.Fatalf(\"expected data envelope, got %T\", m[\"data\"])\n\t}\n\tif data[\"id\"] != float64(1) {\n\t\tt.Errorf(\"data.id: got %v want 1\", data[\"id\"])\n\t}\n}\n\nfunc TestResponse_Created(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.Created(map[string]any{\"name\": \"Alice\"})\n\n\tif rr.Code != http.StatusCreated {\n\t\tt.Errorf(\"status: got %d want 201\", rr.Code)\n\t}\n\tm := decodeJSON(t, rr)\n\tif _, ok := m[\"data\"]; !ok {\n\t\tt.Error(\"expected 'data' key in response\")\n\t}\n}\n\nfunc TestResponse_NoContent(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.NoContent()\n\n\tif rr.Code != http.StatusNoContent {\n\t\tt.Errorf(\"status: got %d want 204\", rr.Code)\n\t}\n\tif rr.Body.Len() != 0 {\n\t\tt.Errorf(\"expected empty body, got %q\", rr.Body.String())\n\t}\n}\n\n// ── Error helpers ─────────────────────────────────────────────────────────────\n\nfunc TestResponse_Error(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.Error(http.StatusBadRequest, \"bad input\")\n\n\tif rr.Code != http.StatusBadRequest {\n\t\tt.Errorf(\"status: got %d want 400\", rr.Code)\n\t}\n\tm := decodeJSON(t, rr)\n\tif m[\"message\"] != \"bad input\" {\n\t\tt.Errorf(\"message: got %v want 'bad input'\", m[\"message\"])\n\t}\n}\n\nfunc TestResponse_Unauthorized_DefaultMessage(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.Unauthorized()\n\n\tif rr.Code != http.StatusUnauthorized {\n\t\tt.Errorf(\"status: got %d want 401\", rr.Code)\n\t}\n\tm := decodeJSON(t, rr)\n\tif m[\"message\"] != \"Unauthenticated.\" {\n\t\tt.Errorf(\"message: got %v\", m[\"message\"])\n\t}\n}\n\nfunc TestResponse_Unauthorized_CustomMessage(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.Unauthorized(\"Token expired.\")\n\n\tm := decodeJSON(t, rr)\n\tif m[\"message\"] != \"Token expired.\" {\n\t\tt.Errorf(\"message: got %v\", m[\"message\"])\n\t}\n}\n\nfunc TestResponse_Forbidden(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.Forbidden()\n\n\tif rr.Code != http.StatusForbidden {\n\t\tt.Errorf(\"status: got %d want 403\", rr.Code)\n\t}\n\tm := decodeJSON(t, rr)\n\tif m[\"message\"] != \"This action is unauthorized.\" {\n\t\tt.Errorf(\"message: got %v\", m[\"message\"])\n\t}\n}\n\nfunc TestResponse_NotFound(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.NotFound()\n\n\tif rr.Code != http.StatusNotFound {\n\t\tt.Errorf(\"status: got %d want 404\", rr.Code)\n\t}\n}\n\nfunc TestResponse_ServerError(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.ServerError()\n\n\tif rr.Code != http.StatusInternalServerError {\n\t\tt.Errorf(\"status: got %d want 500\", rr.Code)\n\t}\n}\n\n// ── ValidationError ───────────────────────────────────────────────────────────\n\nfunc TestResponse_ValidationError(t *testing.T) {\n\tres, rr := newResponse(t)\n\n\tv := validation.Make(\n\t\tmap[string]string{\"email\": \"\"},\n\t\tvalidation.Rules{\"email\": \"required|email\"},\n\t)\n\t_ = v.Fails()\n\tres.ValidationError(v.Errors())\n\n\tif rr.Code != http.StatusUnprocessableEntity {\n\t\tt.Errorf(\"status: got %d want 422\", rr.Code)\n\t}\n\n\tvar body struct {\n\t\tErrors map[string][]string `json:\"errors\"`\n\t}\n\tif err := json.NewDecoder(rr.Body).Decode(&body); err != nil {\n\t\tt.Fatalf(\"decode: %v\", err)\n\t}\n\tif _, ok := body.Errors[\"email\"]; !ok {\n\t\tt.Error(\"expected 'email' key in errors\")\n\t}\n}\n\n// ── Redirects ─────────────────────────────────────────────────────────────────\n\nfunc TestResponse_RedirectTo(t *testing.T) {\n\tres, rr := newResponse(t)\n\tres.RedirectTo(\"/dashboard\")\n\n\tif rr.Code != http.StatusFound {\n\t\tt.Errorf(\"status: got %d want 302\", rr.Code)\n\t}\n\tif loc := rr.Header().Get(\"Location\"); loc != \"/dashboard\" {\n\t\tt.Errorf(\"Location: got %q want /dashboard\", loc)\n\t}\n}\n\nfunc TestResponse_RedirectBack_WithReferer(t *testing.T) {\n\trr := httptest.NewRecorder()\n\tres := gohttp.NewResponse(rr)\n\n\tr := httptest.NewRequest(http.MethodGet, \"/\", nil)\n\tr.Header.Set(\"Referer\", \"/previous\")\n\n\tres.RedirectBack(r, \"/home\")\n\n\tif rr.Code != http.StatusFound {\n\t\tt.Errorf(\"status: got %d want 302\", rr.Code)\n\t}\n\tif loc := rr.Header().Get(\"Location\"); loc != \"/previous\" {\n\t\tt.Errorf(\"Location: got %q want /previous\", loc)\n\t}\n}\n\nfunc TestResponse_RedirectBack_Fallback(t *testing.T) {\n\trr := httptest.NewRecorder()\n\tres := gohttp.NewResponse(rr)\n\n\tr := httptest.NewRequest(http.MethodGet, \"/\", nil)\n\t// No Referer header\n\tres.RedirectBack(r, \"/home\")\n\n\tif loc := rr.Header().Get(\"Location\"); loc != \"/home\" {\n\t\tt.Errorf(\"Location fallback: got %q want /home\", loc)\n\t}\n}\n\n// ── Raw() ─────────────────────────────────────────────────────────────────────\n\nfunc TestResponse_Raw(t *testing.T) {\n\t_, rr := newResponse(t)\n\tres := gohttp.NewResponse(rr)\n\tif res.Raw() == nil {\n\t\tt.Error(\"Raw() should not be nil\")\n\t}\n}\n"
        }
    ]
}